name: Publish Pages

on:
  workflow_dispatch:
  workflow_call:

jobs:

  pages:
    name: Publish GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: "pages"
      cancel-in-progress: true
    permissions:
      contents: read
      packages: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Fetch GitHub Stats
        run: |
          set -e
          
          # Fetch stars count
          echo "Fetching GitHub stars..."
          REPO_RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.github.com/repos/${{ github.repository }}")
          HTTP_CODE=$(echo "$REPO_RESPONSE" | tail -n1)
          REPO_DATA=$(echo "$REPO_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            STARS=$(echo "$REPO_DATA" | jq -r '.stargazers_count // 0')
          else
            echo "Warning: Failed to fetch stars (HTTP $HTTP_CODE), using 0"
            STARS=0
          fi
          
          # Fetch contributors count (handle pagination)
          echo "Fetching GitHub contributors..."
          CONTRIBUTORS=0
          PAGE=1
          MAX_PAGES=10
          
          while [ $PAGE -le $MAX_PAGES ]; do
            CONTRIB_RESPONSE=$(curl -s -w "\n%{http_code}" "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=100&page=$PAGE")
            CONTRIB_HTTP_CODE=$(echo "$CONTRIB_RESPONSE" | tail -n1)
            CONTRIB_DATA=$(echo "$CONTRIB_RESPONSE" | sed '$d')
            
            if [ "$CONTRIB_HTTP_CODE" != "200" ]; then
              echo "Warning: Failed to fetch contributors page $PAGE (HTTP $CONTRIB_HTTP_CODE)"
              break
            fi
            
            CONTRIBUTORS_PAGE=$(echo "$CONTRIB_DATA" | jq 'length')
            if [ "$CONTRIBUTORS_PAGE" -eq 0 ]; then
              break
            fi
            
            CONTRIBUTORS=$((CONTRIBUTORS + CONTRIBUTORS_PAGE))
            
            # Check if there are more pages by checking if we got a full page
            if [ "$CONTRIBUTORS_PAGE" -lt 100 ]; then
              break
            fi
            
            PAGE=$((PAGE + 1))
          done
          
          # Update githubStats.ts file
          cat > website/src/components/OpenSourceSection/githubStats.ts << EOF
          /**
           * GitHub statistics fetched at build time
           * These values are automatically updated during the build process
           * Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
           */
          export const GITHUB_STATS = {
            stars: ${STARS}, // Fetched from GitHub API at build time
            contributors: ${CONTRIBUTORS}, // Fetched from GitHub API at build time
          } as const;
          EOF
          
          echo "âœ… Updated GitHub stats: Stars=$STARS, Contributors=$CONTRIBUTORS"
        shell: bash
      - name: Building Website
        run: |
          npm -C website ci
          npm -C website run build
          cp -r website/build/* pages/
      - name: Install oras
        uses: oras-project/setup-oras@v1
      - name: Setup Helm
        uses: azure/setup-helm@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      - name: Pull Helm charts
        run: |
          CHARTS_REPO_BASE="ghcr.io/${{ github.repository }}/charts"
          HELM_PAGES_DIR="pages/charts"
          mkdir -p "${HELM_PAGES_DIR}"
          OPERATOR_VERSIONS=$(oras repo tags "${CHARTS_REPO_BASE}/slv-operator" | sort -Vu)
          for v in $OPERATOR_VERSIONS; do
            helm pull "oci://${CHARTS_REPO_BASE}/slv-operator" --version "$v" -d "${HELM_PAGES_DIR}"
          done
          JOB_VERSIONS=$(oras repo tags "${CHARTS_REPO_BASE}/slv-job" | sort -Vu)
          for v in $JOB_VERSIONS; do
            helm pull "oci://${CHARTS_REPO_BASE}/slv-job" --version "$v" -d "${HELM_PAGES_DIR}"
          done
          helm repo index "${HELM_PAGES_DIR}" --url "${{ steps.pages.outputs.base_url }}/charts"
        shell: bash
      - name: Add static assets
        run: |
          CHARTS_REPO_BASE="ghcr.io/${{ github.repository }}/charts"
          mkdir -p pages/k8s/samples/deploy
          LATEST_OPERATOR_CHART_VERSION=$(oras repo tags "${CHARTS_REPO_BASE}/slv-operator" | sort -Vu | tail -n 1)
          helm pull "oci://${CHARTS_REPO_BASE}/slv-operator" --version $LATEST_OPERATOR_CHART_VERSION --untar -d ./.charts
          helm template slv ./.charts/slv-operator --namespace slv > pages/k8s/samples/deploy/operator.yaml
          LATEST_JOB_CHART_VERSION=$(oras repo tags "${CHARTS_REPO_BASE}/slv-job" | sort -Vu | tail -n 1)
          helm pull "oci://${CHARTS_REPO_BASE}/slv-job" --version $LATEST_JOB_CHART_VERSION --untar -d ./.charts
          helm template slv ./.charts/slv-job --namespace slv > pages/k8s/samples/deploy/job.yaml
          cp internal/k8s/config/crd/bases/slv.sh_slvs.yaml pages/k8s/crd.yaml
          cp internal/k8s/config/samples/slv_v1_slv.yaml pages/k8s/samples/pets.slv.yaml
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
